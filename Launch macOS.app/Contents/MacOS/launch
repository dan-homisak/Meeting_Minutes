#!/bin/bash

set -euo pipefail

export PATH="/usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin:/usr/sbin:/sbin${PATH:+:$PATH}"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/../../.." && pwd)"
VENV_PYTHON="${PROJECT_ROOT}/.venv/bin/python"
LOG_FILE="${PROJECT_ROOT}/launch.log"

escape_applescript() {
  printf '%s' "$1" | sed 's/\\/\\\\/g; s/"/\\"/g'
}

notify() {
  local message
  message=$(escape_applescript "$1")
  /usr/bin/osascript <<EOF
display notification "$message" with title "App Launcher"
EOF
}

fail() {
  local message
  message=$(escape_applescript "$1")
  /usr/bin/osascript <<EOF
display dialog "$message" buttons {"OK"} default button "OK" with icon stop with title "App Launcher"
EOF
  exit 1
}

if [[ ! -x "${VENV_PYTHON}" ]]; then
  fail "Missing .venv. Run scripts/setup.sh first to create the project environment."
fi

notify "Starting local serverâ€¦"

cd "${PROJECT_ROOT}"

{
  "${VENV_PYTHON}" run.py
} >>"${LOG_FILE}" 2>&1 || fail "Server exited with an error. Inspect launch.log."
